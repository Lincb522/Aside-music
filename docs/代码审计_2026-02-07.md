# AsideMusic 代码审计报告（2026-02-07）

## 审计范围
- 业务代码：Sources/AsideMusic（网络、数据库、管理器、视图与组件）
- 构建与配置：build_ipa.sh、scripts/inject_env.sh、Package.swift、AsideMusic.xcodeproj
- 未纳入：第三方依赖源码与外部后端服务

## 总体结论
- 发现若干安全与稳定性风险点，主要集中在网络传输安全、鉴权信息存储方式、强制解包/强转导致的崩溃风险、以及配置脚本路径错误。
- 建议优先修复高风险项（明文 HTTP、Cookie 存储与 URL 参数泄露、强制解包/强转）。

## 主要问题清单

### 高风险
1. **默认使用明文 HTTP 的后端地址**
   - 影响：可能遭受中间人攻击，用户登录态与请求内容被窃取或篡改。
   - 证据：[APIService.swift:L13-L24](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Network/APIService.swift#L13-L24)
   - 建议：提供 HTTPS 地址作为默认值，或要求配置项必须存在，不允许明文回退。

2. **将 Cookie 附加到 URL Query 与 UserDefaults**
   - 影响：Cookie 进入 URL 可能被日志、缓存、代理记录；存储在 UserDefaults 不具备系统级安全保护。
   - 证据：
     - URL Query：[APIService.swift:L120-L134](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Network/APIService.swift#L120-L134)
     - UserDefaults 存储：[APIService.swift:L27-L58](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Network/APIService.swift#L27-L58)
   - 建议：Cookie 仅通过 Header 传递；敏感信息使用 Keychain 存储。

3. **强制解包与强制类型转换可能导致崩溃**
   - 影响：服务端返回异常或字段为空时会直接崩溃。
   - 证据：
     - `priv.id!`： [APIService.swift:L303-L317](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Network/APIService.swift#L303-L317)
     - `response.proxyUrl!` / `response.data!.proxyUrl!`： [APIService.swift:L480-L512](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Network/APIService.swift#L480-L512)
     - `error as! PlaybackError`： [PlayerManager.swift:L524-L538](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/ViewModels/PlayerManager.swift#L524-L538)
   - 建议：改为可选绑定与安全解包，或使用 `as?` 并提供兜底逻辑。

### 中风险
4. **数据库初始化失败直接崩溃**
   - 影响：初始化失败会导致应用无法启动，缺少降级策略与错误上报。
   - 证据：
     - [DatabaseManager.swift:L16-L40](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Database/DatabaseManager.swift#L16-L40)
     - [AsideMusicApp.swift:L10-L28](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/AsideMusicApp.swift#L10-L28)
   - 建议：改为可恢复错误处理（提示用户、清理损坏数据、回退到内存数据库等）。

5. **环境变量注入脚本路径错误**
   - 影响：`.env` 变量无法注入到 Info.plist，导致 API_BASE_URL 等配置失效。
   - 证据：[inject_env.sh:L4-L28](file:///Users/linchengbo/Downloads/asidemusic-main/scripts/inject_env.sh#L4-L28)
   - 建议：修正为 `Sources/AsideMusic/Info.plist`，并在构建脚本或文档中说明执行顺序。

6. **生产环境日志可能包含接口错误信息**
   - 影响：错误响应体与内部错误信息进入系统日志，存在隐私泄露风险。
   - 证据：[APIService.swift:L141-L158](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Network/APIService.swift#L141-L158)
   - 建议：在 Release 构建中降级日志内容或增加脱敏策略。

### 低风险
7. **存在未完成的设置项**
   - 影响：功能入口与提示不一致，降低用户体验。
   - 证据：[SettingsView.swift:L110](file:///Users/linchengbo/Downloads/asidemusic-main/Sources/AsideMusic/Views/SettingsView.swift#L110)
   - 建议：实现或隐藏未完成项。

## 修复优先级建议
- P0：默认 HTTP 回退、Cookie 处理（Query + UserDefaults）、强制解包/强转
- P1：数据库初始化崩溃、环境变量注入脚本路径
- P2：日志脱敏、未完成 UI 项

## 检查与验证
- 未发现项目内统一的 lint/typecheck/测试命令，未执行自动化检查。

## 建议的下一步
- 先修复高风险项并补充单元测试（网络层、播放异常、解灰分支）。
- 引入安全存储（Keychain）与 HTTPS 强制策略。
- 补充 CI 检查脚本（至少包含构建与静态分析）。

## 详细落地方案：Keychain 与 HTTPS

### 1) Keychain 存储替代 UserDefaults（Cookie/UID）
- 范围：替换 APIService 中的 cookieKey/userIdKey 的 UserDefaults 读写
- 目标：鉴权信息仅写入 Keychain，避免被备份与明文读取
- 实施步骤：
  - 新增 Keychain 存取工具（读/写/删除/查询）
  - 迁移逻辑：启动时优先从 Keychain 读取；若 UserDefaults 有旧值则迁移后删除旧值
  - 写入规则：登录/刷新 Cookie 时只写 Keychain，不写 UserDefaults
  - 清理规则：登出时清空 Keychain 中 cookie/uid
  - 访问控制建议：kSecAttrAccessibleAfterFirstUnlock 或 kSecAttrAccessibleWhenUnlocked
- 验收标准：
  - 用户登录后，UserDefaults 不再出现 cookie/uid
  - 关闭/重启 App 后登录态依旧可恢复
  - 登出后 Keychain 相关项被清空

### 2) 禁止 Cookie 拼接到 URL Query
- 范围：APIService.fetch 中对 GET 的 cookie query 拼接逻辑
- 目标：Cookie 仅通过 Header 传递，杜绝 URL 泄露
- 实施步骤：
  - 移除 queryItems 中 cookie 的追加逻辑
  - 保留 Header 中 Cookie 传递方式
- 验收标准：
  - 请求 URL 不包含 cookie 参数
  - 登录相关接口仍可正常访问

### 3) HTTPS 强制策略
- 范围：APIService.baseURL 默认值、Info.plist ATS、构建配置
- 目标：默认只允许 HTTPS，避免生产环境走明文 HTTP
- 实施步骤：
  - baseURL 默认值改为 HTTPS 或强制必须配置 API_BASE_URL
  - Info.plist 开启 ATS（默认已启用），确保未放行不必要的 NSAllowsArbitraryLoads
  - 若开发环境必须 HTTP：仅在 Debug 配置里通过 ATS 例外域名放行
  - 构建流程：将 API_BASE_URL 作为必填项注入，避免 HTTP 回退
- 验收标准：
  - Release 配置下 HTTP 地址不可访问
  - Debug 配置下可按需访问指定 HTTP 域名
  - 未配置 API_BASE_URL 时能够明确失败并提示
