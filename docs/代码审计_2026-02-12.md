# AsideMusic ä»£ç å®¡è®¡æŠ¥å‘Šï¼ˆ2026-02-12ï¼Œå…¨é¢è¯¦ç»†ç‰ˆï¼‰

## å®¡è®¡èŒƒå›´

- ä¸šåŠ¡ä»£ç ï¼šSources/AsideMusic å…¨éƒ¨æ¨¡å—ï¼ˆNetworkã€Databaseã€Managersã€ViewModelsã€Viewsã€Modelsã€Utilsï¼‰
- SDK å±‚ï¼šFFmpegSwiftSDKï¼ˆStreamPlayerã€AudioEqualizerï¼‰
- æ„å»ºé…ç½®ï¼šPackage.swiftã€AsideMusic.xcodeproj
- æœªçº³å…¥ï¼šç¬¬ä¸‰æ–¹ä¾èµ–æºç ï¼ˆNeteaseCloudMusicAPI-Swiftã€LiquidGlassEffect å†…éƒ¨å®ç°ï¼‰

## é¡¹ç›®æ¦‚è§ˆ

- UIï¼šSwiftUIï¼ŒTab åˆ‡æ¢ä½¿ç”¨ opacity é¢„åŠ è½½ç­–ç•¥
- æ¶æ„ï¼šMVVM + Singletonï¼ŒViewModel é€šè¿‡ Combine é©±åŠ¨ View
- ç½‘ç»œï¼šNCMClientï¼ˆNeteaseCloudMusicAPI-Swiftï¼‰+ Combine Publisher æ¡¥æ¥
- æ•°æ®ï¼šSwiftData ä¸‰çº§é™çº§ï¼ˆç£ç›˜ â†’ é‡å»º â†’ å†…å­˜ï¼‰+ ä¸‰çº§ç¼“å­˜ï¼ˆNSCache â†’ SwiftData â†’ ç£ç›˜æ–‡ä»¶ï¼‰
- æ’­æ”¾ï¼šFFmpegSwiftSDK StreamPlayer + AVAudioSession + MediaPlayer è¿œç¨‹æ§åˆ¶
- éŸ³é¢‘å¤„ç†ï¼š10 æ®µ Biquad Peaking EQï¼Œ24 ä¸ªä¸“ä¸šé¢„è®¾
- ä¾èµ–ï¼šSPMï¼ˆFFmpegSwiftSDKã€NeteaseCloudMusicAPI-Swiftã€LiquidGlassEffectï¼‰

## æ¶æ„åˆ†å±‚

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Presentation Layer                              â”‚
â”‚  Views / Components / AsideIcons / Theme         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ViewModel Layer                                 â”‚
â”‚  PlayerManager / HomeViewModel / LoginViewModel  â”‚
â”‚  MVViewModel / CommentViewModel                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Manager Layer                                   â”‚
â”‚  EQManager / SubscriptionManager / CacheManager  â”‚
â”‚  GlobalRefreshManager / DataSyncCoordinator      â”‚
â”‚  OptimizedCacheManager / OrientationManager      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Network Layer                                   â”‚
â”‚  APIService / NCMBridge / APIService+Search/MV   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Layer                                      â”‚
â”‚  DatabaseManager / SongRepository                â”‚
â”‚  PlaylistRepository / HistoryRepository          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  SDK Layer (FFmpegSwiftSDK)                      â”‚
â”‚  StreamPlayer / AudioRenderer / AudioEqualizer   â”‚
â”‚  ConnectionManager / PacketQueue                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ ¸å¿ƒæ•°æ®æµ

```mermaid
flowchart TD
    UI[Views] --> VM[ViewModels]
    VM --> API[APIService / NCMClient]
    VM --> MGR[Managers]
    API --> NCM[NCMBridge â†’ Combine Publisher]
    API --> Cache[OptimizedCacheManager]
    Cache --> L1[NSCache å†…å­˜]
    Cache --> L2[SwiftData æ•°æ®åº“]
    Cache --> L3[CacheManager ç£ç›˜æ–‡ä»¶]
    VM --> PM[PlayerManager]
    PM --> SP[StreamPlayer / FFmpeg]
    SP --> EQ[AudioEqualizer / 10-Band EQ]
    PM --> NP[MPNowPlayingInfoCenter]
    MGR --> GRM[GlobalRefreshManager]
    GRM --> VM
```

## é£é™©çŸ©é˜µ

| # | ç±»åˆ« | é£é™©ç‚¹ | ç­‰çº§ | å½±å“é¢ | ä¼˜å…ˆçº§ |
|---|------|--------|------|--------|--------|
| 1 | å®‰å…¨ | Cookie æ˜æ–‡å­˜å‚¨åœ¨ UserDefaults | ğŸ”´ é«˜ | è´¦å·å®‰å…¨ | P0 |
| 2 | æ•°æ® | restoreState ä¸¢å¤±å®Œæ•´æ’­æ”¾é˜Ÿåˆ— | ğŸ”´ é«˜ | ç”¨æˆ·ä½“éªŒ | P0 |
| 3 | æ€§èƒ½ | @MainActor ä¸Šæ‰§è¡Œæ•°æ®åº“æ‰¹é‡ I/O | ğŸŸ¡ ä¸­ | UI æµç•…åº¦ | P1 |
| 4 | ä»£ç  | CachePolicy å‚æ•°ä¸ºæ­»ä»£ç  | ğŸŸ¡ ä¸­ | ä»£ç è´¨é‡ | P1 |
| 5 | ä»£ç  | WaveformProgressBar é‡å¤å®ç° | ğŸŸ¡ ä¸­ | ç»´æŠ¤æˆæœ¬ | P1 |
| 6 | æ€§èƒ½ | åŒ NSCache å®ä¾‹ï¼ˆ200MB ä¸Šé™ï¼‰ | ğŸŸ¡ ä¸­ | å†…å­˜å ç”¨ | P1 |
| 7 | å¹¶å‘ | DataSyncCoordinator continuation æ³„æ¼é£é™© | ğŸŸ¡ ä¸­ | å†…å­˜æ³„æ¼ | P1 |
| 8 | é€»è¾‘ | å¼‚å¸¸ç»“æŸæ£€æµ‹æ¡ä»¶è¿‡äºå®½æ¾ | ğŸŸ¡ ä¸­ | æ’­æ”¾ä½“éªŒ | P1 |
| 9 | é€»è¾‘ | EQManager ä¸ PlayerManager å•ä¾‹åˆå§‹åŒ–å¾ªç¯ä¾èµ– | ğŸŸ¡ ä¸­ | å¯åŠ¨ç¨³å®šæ€§ | P1 |
| 10 | é€»è¾‘ | SubscriptionManager ä¹è§‚æ›´æ–°ç«æ€ | ğŸŸ¡ ä¸­ | æ•°æ®ä¸€è‡´æ€§ | P1 |
| 11 | ä»£ç  | NotificationCenter å­—ç¬¦ä¸²é€šçŸ¥å | ğŸŸ¢ ä½ | å¯ç»´æŠ¤æ€§ | P2 |
| 12 | ä»£ç  | Tab.icon SF Symbol æ­»ä»£ç  | ğŸŸ¢ ä½ | ä»£ç æ•´æ´ | P2 |
| 13 | æ¶æ„ | å…¨å±€å•ä¾‹ç´§è€¦åˆ | ğŸŸ¢ ä½ | å¯æµ‹è¯•æ€§ | P2 |
| 14 | æ€§èƒ½ | TimelineView åå°æŒç»­é‡ç»˜ | ğŸŸ¢ ä½ | ç”µæ± æ¶ˆè€— | P2 |



## è¯¦ç»†é—®é¢˜åˆ†æ

---

### ğŸ”´ P0-1ï¼šCookie æ˜æ–‡å­˜å‚¨åœ¨ UserDefaults

**æ–‡ä»¶**ï¼š`Network/APIService.swift`

**ç°çŠ¶**ï¼š
```swift
var currentCookie: String? {
    get { UserDefaults.standard.string(forKey: cookieKey) }
    set { UserDefaults.standard.set(newValue, forKey: cookieKey) }
}
```

**é£é™©**ï¼š
- UserDefaults çš„ plist æ–‡ä»¶åœ¨è¶Šç‹±è®¾å¤‡ä¸Šå¯ç›´æ¥è¯»å–
- iTunes å¤‡ä»½é»˜è®¤åŒ…å« UserDefaults æ•°æ®ï¼ŒCookie å¯èƒ½è¢«æå–
- ä¸å…·å¤‡ç³»ç»Ÿçº§åŠ å¯†ä¿æŠ¤

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- è¿ç§»åˆ° Keychain å­˜å‚¨ï¼Œä½¿ç”¨ `kSecAttrAccessibleAfterFirstUnlock`
- å¯åŠ¨æ—¶æ£€æŸ¥ UserDefaults æ—§å€¼ï¼Œè¿ç§»ååˆ é™¤
- ç™»å‡ºæ—¶æ¸…ç©º Keychain ä¸­çš„ cookie å’Œ uid

**éªŒæ”¶æ ‡å‡†**ï¼š
- UserDefaults ä¸­ä¸å†å‡ºç° cookie/uid
- é‡å¯ App åç™»å½•æ€å¯æ¢å¤
- ç™»å‡ºå Keychain ç›¸å…³é¡¹è¢«æ¸…ç©º

---

### ğŸ”´ P0-2ï¼šrestoreState ä¸¢å¤±å®Œæ•´æ’­æ”¾é˜Ÿåˆ—

**æ–‡ä»¶**ï¼š`ViewModels/PlayerManager.swift`

**ç°çŠ¶**ï¼š
```swift
// PlayerState åªä¿å­˜äº† currentSongã€userQueueã€modeã€historyã€playSource
// æ²¡æœ‰ä¿å­˜ contextï¼ˆå®Œæ•´æ’­æ”¾åˆ—è¡¨ï¼‰å’Œ contextIndex

private func restoreState() {
    // ...
    if let song = state.currentSong {
        self.currentSong = song
        self.context = [song]        // â† åªæ¢å¤äº†å½“å‰æ­Œæ›²
        self.contextIndex = 0
    }
}
```

**å½±å“**ï¼š
- é‡å¯ App åï¼Œç”¨æˆ·ä¹‹å‰çš„æ’­æ”¾åˆ—è¡¨ï¼ˆå¯èƒ½æœ‰å‡ åé¦–æ­Œï¼‰å…¨éƒ¨ä¸¢å¤±
- åªå‰©å½“å‰ä¸€é¦–æ­Œï¼Œæ— æ³•åˆ‡æ¢åˆ°é˜Ÿåˆ—ä¸­çš„å…¶ä»–æ­Œæ›²
- ä¸Šä¸€é¦–/ä¸‹ä¸€é¦–åŠŸèƒ½åœ¨é‡å¯åå¤±æ•ˆ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```swift
struct PlayerState: Codable {
    let currentSong: Song?
    let context: [Song]           // â† æ–°å¢
    let contextIndex: Int         // â† æ–°å¢
    let userQueue: [Song]
    let mode: PlayMode
    let history: [Song]
    let playSource: PlaySource?
}
```
- ä¿å­˜æ—¶åºåˆ—åŒ–å®Œæ•´ context å’Œ contextIndex
- æ¢å¤æ—¶é‡å»ºå®Œæ•´æ’­æ”¾é˜Ÿåˆ—
- è€ƒè™‘ context è¿‡å¤§æ—¶çš„æˆªæ–­ç­–ç•¥ï¼ˆå¦‚æœ€å¤šä¿å­˜ 200 é¦–ï¼‰

---

### ğŸŸ¡ P1-3ï¼š@MainActor ä¸Šæ‰§è¡Œæ•°æ®åº“æ‰¹é‡ I/O

**æ–‡ä»¶**ï¼š`Managers/OptimizedCacheManager.swift`ã€`Database/DatabaseManager.swift`

**ç°çŠ¶**ï¼š
```swift
@MainActor
final class OptimizedCacheManager: ObservableObject {
    // songRepo.save(songs:) åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ
    func cacheSongs(_ songs: [Song]) {
        for song in songs {
            let cacheKey = "song_\(song.id)" as NSString
            memoryCache.setObject(song as AnyObject, forKey: cacheKey)
        }
        Task.detached { @MainActor in
            self.songRepo.save(songs: songs)  // â† ä»ç„¶åœ¨ MainActor ä¸Š
        }
    }
}
```

`Task.detached { @MainActor in }` å®é™…ä¸Šä»ç„¶åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œï¼Œ`detached` åªæ˜¯è„±ç¦»äº†å½“å‰ Task çš„ä¼˜å…ˆçº§ç»§æ‰¿ï¼Œä½† `@MainActor` åˆæŠŠå®ƒæ‹‰å›ä¸»çº¿ç¨‹ã€‚

**å½±å“**ï¼š
- æ‰¹é‡ä¿å­˜å‡ åé¦–æ­Œæ›²æ—¶å¯èƒ½é€ æˆ UI å¡é¡¿
- ç‰¹åˆ«æ˜¯ç™»å½•åé¦–æ¬¡åŒæ­¥å¤§é‡æ•°æ®æ—¶

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ SwiftData çš„ `ModelActor` åœ¨åå°çº¿ç¨‹æ‰§è¡Œæ‰¹é‡å†™å…¥
- æˆ–è€…ä½¿ç”¨ç‹¬ç«‹çš„ `ModelContext`ï¼ˆé mainContextï¼‰åœ¨åå°é˜Ÿåˆ—æ“ä½œ
- å†…å­˜ç¼“å­˜æ›´æ–°ä¿ç•™åœ¨ä¸»çº¿ç¨‹ï¼Œæ•°æ®åº“å†™å…¥ç§»åˆ°åå°

---

### ğŸŸ¡ P1-4ï¼šCachePolicy å‚æ•°ä¸ºæ­»ä»£ç 

**æ–‡ä»¶**ï¼š`Network/APIService.swift`

**ç°çŠ¶**ï¼š
```swift
func fetchDailySongs(cachePolicy: CachePolicy = .networkOnly, ttl: TimeInterval? = nil) 
    -> AnyPublisher<[Song], Error> {
    // cachePolicy å’Œ ttl å®Œå…¨æ²¡æœ‰è¢«ä½¿ç”¨
    ncm.fetch([Song].self, keyPath: "data.dailySongs") { [ncm] in
        try await ncm.recommendSongs()
    }
}

func fetchPlaylistTracks(id: Int, limit: Int = 30, offset: Int = 0, 
    cachePolicy: CachePolicy = .networkOnly, ttl: TimeInterval? = nil) 
    -> AnyPublisher<[Song], Error> {
    // åŒæ ·æœªä½¿ç”¨
}
```

`CachePolicy` æšä¸¾å®šä¹‰äº† 4 ç§ç­–ç•¥ï¼ˆnetworkOnlyã€returnCacheDataElseLoadã€returnCacheDataDontLoadã€staleWhileRevalidateï¼‰ï¼Œä½†æ²¡æœ‰ä»»ä½•æ–¹æ³•å®é™…ä½¿ç”¨è¿™äº›å‚æ•°ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ–¹æ¡ˆ Aï¼šç§»é™¤æœªä½¿ç”¨çš„å‚æ•°å’Œ `CachePolicy` æšä¸¾ï¼Œç¼“å­˜é€»è¾‘å·²ç”± `OptimizedCacheManager.smartFetch` æ‰¿æ‹…
- æ–¹æ¡ˆ Bï¼šåœ¨ NCMBridge å±‚å®ç°ç¼“å­˜ç­–ç•¥æ‹¦æˆª

---

### ğŸŸ¡ P1-5ï¼šWaveformProgressBar é‡å¤å®ç°

**æ–‡ä»¶**ï¼š`Views/FullScreenPlayerView.swift`ã€`Views/PersonalFMView.swift`

ä¸¤ä¸ªæ–‡ä»¶ä¸­å„æœ‰ä¸€ä»½å‡ ä¹å®Œå…¨ç›¸åŒçš„ `WaveformProgressBar` å®ç°ï¼ˆçº¦ 60 è¡Œï¼‰ï¼Œä»…åœ¨ `barCount`ã€`barSpacing`ã€`minHeight` ç­‰å‚æ•°ä¸Šæœ‰ç»†å¾®å·®å¼‚ã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æå–ä¸º `Views/Components/WaveformProgressBar.swift` å…±äº«ç»„ä»¶
- é€šè¿‡å‚æ•°æ§åˆ¶ barCountã€spacing ç­‰å·®å¼‚
- ä¸¤å¤„å¼•ç”¨æ”¹ä¸ºä½¿ç”¨å…±äº«ç»„ä»¶

---

### ğŸŸ¡ P1-6ï¼šåŒ NSCache å®ä¾‹

**æ–‡ä»¶**ï¼š`Managers/OptimizedCacheManager.swift`ã€`Managers/CacheManager.swift`

**ç°çŠ¶**ï¼š
- `OptimizedCacheManager` æœ‰è‡ªå·±çš„ `NSCache`ï¼ˆ100MBã€200 æ¡ï¼‰
- `CacheManager` ä¹Ÿæœ‰è‡ªå·±çš„ `NSCache`ï¼ˆ100MBã€100 æ¡ï¼‰
- `OptimizedCacheManager` å†…éƒ¨å¼•ç”¨ `CacheManager.shared` ä½œä¸º L3 ç£ç›˜ç¼“å­˜
- ä¸¤ä¸ª NSCache å¯èƒ½ç¼“å­˜ç›¸åŒçš„æ•°æ®ï¼ˆå¦‚ `daily_songs`ï¼‰ï¼Œé€ æˆå†…å­˜æµªè´¹

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- ç»Ÿä¸€ä¸ºå•ä¸€ç¼“å­˜ç®¡ç†å™¨ï¼Œ`CacheManager` é™çº§ä¸ºçº¯ç£ç›˜ç¼“å­˜å·¥å…·
- æˆ–è€…è®© `OptimizedCacheManager` çš„é€šç”¨å¯¹è±¡ç¼“å­˜ç›´æ¥ä½¿ç”¨ `CacheManager` çš„ NSCacheï¼Œé¿å…åŒä»½å†…å­˜ç¼“å­˜

---

### ğŸŸ¡ P1-7ï¼šDataSyncCoordinator continuation æ³„æ¼é£é™©

**æ–‡ä»¶**ï¼š`Managers/DataSyncCoordinator.swift`

**ç°çŠ¶**ï¼š
```swift
private func syncDailySongs() async -> [Song] {
    return await withCheckedContinuation { continuation in
        apiService.fetchDailySongs()
            .sink(
                receiveCompletion: { completion in
                    if case .failure = completion {
                        continuation.resume(returning: [])
                    }
                },
                receiveValue: { songs in
                    // ...
                    continuation.resume(returning: songs)
                }
            )
            .store(in: &cancellables)
    }
}
```

**é£é™©**ï¼š
- å¦‚æœ Publisher æ­£å¸¸å®Œæˆï¼ˆ`.finished`ï¼‰ä½†æ²¡æœ‰å‘å‡ºä»»ä½•å€¼ï¼Œ`receiveCompletion` ä¸­çš„ `.finished` åˆ†æ”¯æ²¡æœ‰å¤„ç†ï¼Œcontinuation æ°¸è¿œä¸ä¼šè¢« resume
- `store(in: &cancellables)` ä¸ä¼šå–æ¶ˆæ—§çš„ subscriptionï¼Œå¦‚æœ `syncAllCoreData()` è¢«å¤šæ¬¡è°ƒç”¨ï¼Œæ—§çš„ continuation å¯èƒ½æ³„æ¼

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
```swift
receiveCompletion: { completion in
    switch completion {
    case .failure:
        continuation.resume(returning: [])
    case .finished:
        break  // receiveValue å·²ç» resume äº†
    }
}
```
- æˆ–è€…æ”¹ç”¨ `async/await` ç‰ˆæœ¬çš„ NCMBridgeï¼ˆå·²æœ‰ `Publisher.async()` æ‰©å±•ï¼‰

---

### ğŸŸ¡ P1-8ï¼šå¼‚å¸¸ç»“æŸæ£€æµ‹æ¡ä»¶è¿‡äºå®½æ¾

**æ–‡ä»¶**ï¼š`ViewModels/PlayerManager.swift` â†’ `StreamPlayerDelegateAdapter`

**ç°çŠ¶**ï¼š
```swift
case .stopped:
    // ...
    let playedRatio = pm.duration > 0 ? pm.currentTime / pm.duration : 0
    if pm.duration > 0 && playedRatio < 0.5 && pm.currentTime < 30 {
        // åˆ¤å®šä¸ºå¼‚å¸¸ç»“æŸï¼Œé‡æ–°æ’­æ”¾
        pm.loadAndPlay(song: song)
    } else {
        // æ­£å¸¸ç»“æŸï¼Œè‡ªåŠ¨ä¸‹ä¸€é¦–
        pm.playerDidFinishPlaying()
    }
```

**é—®é¢˜**ï¼š
- ä¸€é¦– 60 ç§’çš„æ­Œæ’­æ”¾äº† 29 ç§’åè¿æ¥ä¸­æ–­ â†’ `playedRatio = 0.48 < 0.5` ä¸” `currentTime = 29 < 30` â†’ è¢«åˆ¤å®šä¸ºå¼‚å¸¸ï¼Œè§¦å‘é‡æ–°æ’­æ”¾è€Œéè·³ä¸‹ä¸€é¦–
- ä¸€é¦– 10 ç§’çš„çŸ­éŸ³é¢‘æ­£å¸¸æ’­æ”¾å®Œæ¯• â†’ `playedRatio = 1.0 > 0.5` â†’ æ­£ç¡®åˆ¤å®šä¸ºæ­£å¸¸ç»“æŸï¼ˆè¿™ä¸ª case æ²¡é—®é¢˜ï¼‰

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ”¹ä¸º `playedRatio < 0.3 && pm.currentTime < 10`ï¼Œæ›´ä¿å®ˆåœ°åˆ¤æ–­å¼‚å¸¸
- æˆ–è€…è®© SDK å±‚åŒºåˆ† EOFï¼ˆæ­£å¸¸ç»“æŸï¼‰å’Œè¿æ¥ä¸­æ–­ï¼ˆå¼‚å¸¸ç»“æŸï¼‰ï¼Œé€šè¿‡ä¸åŒçš„çŠ¶æ€ç ä¼ é€’

---

### ğŸŸ¡ P1-9ï¼šEQManager ä¸ PlayerManager å•ä¾‹åˆå§‹åŒ–å¾ªç¯ä¾èµ–

**æ–‡ä»¶**ï¼š`Managers/EQManager.swift`

**ç°çŠ¶**ï¼š
```swift
// EQManager.init() ä¸­è°ƒç”¨ restoreState()
private func restoreState() {
    // ...
    if isEnabled, let preset = currentPreset {
        preset.apply(to: PlayerManager.shared.equalizer)
        // â† å¦‚æœ EQManager å…ˆäº PlayerManager è¢«è®¿é—®ï¼Œ
        //    è¿™é‡Œä¼šè§¦å‘ PlayerManager.init()
    }
}
```

`EQManager.shared` å’Œ `PlayerManager.shared` äº’ç›¸å¼•ç”¨ï¼š
- `EQManager` åœ¨ `restoreState` ä¸­è®¿é—® `PlayerManager.shared.equalizer`
- `PlayerManager` åœ¨ `init` ä¸­ä¸ç›´æ¥å¼•ç”¨ `EQManager`ï¼Œä½† `EQSettingsView` åŒæ—¶ä½¿ç”¨ä¸¤è€…

**é£é™©**ï¼šè™½ç„¶ Swift çš„ `static let` æ˜¯çº¿ç¨‹å®‰å…¨çš„æ‡’åˆå§‹åŒ–ï¼Œä¸ä¼šæ­»é”ï¼Œä½†åˆå§‹åŒ–é¡ºåºä¸ç¡®å®šå¯èƒ½å¯¼è‡´ EQ çŠ¶æ€æ¢å¤æ—¶ PlayerManager çš„ StreamPlayer è¿˜æœªå®Œå…¨å°±ç»ªã€‚

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- `EQManager.restoreState()` å»¶è¿Ÿ EQ åº”ç”¨ï¼Œç­‰åˆ°é¦–æ¬¡æ’­æ”¾æ—¶å† apply
- æˆ–è€…åœ¨ `AsideMusicApp.onAppear` ä¸­æ˜¾å¼æ§åˆ¶åˆå§‹åŒ–é¡ºåº

---

### ğŸŸ¡ P1-10ï¼šSubscriptionManager ä¹è§‚æ›´æ–°ç«æ€

**æ–‡ä»¶**ï¼š`Managers/SubscriptionManager.swift`

**ç°çŠ¶**ï¼š
```swift
func toggleRadioSubscription(_ radio: RadioStation) {
    let isCurrently = isRadioSubscribed(radio.id)
    let targetState = !isCurrently
    
    // ä¹è§‚æ›´æ–°
    if targetState {
        subscribedRadioIds.insert(radio.id)
    } else {
        subscribedRadioIds.remove(radio.id)
    }
    
    // ç½‘ç»œè¯·æ±‚
    apiService.subscribeDJ(rid: radio.id, subscribe: targetState)
        .sink(receiveCompletion: { completion in
            if case .failure = completion {
                // å›æ»š
            }
        }, receiveValue: { _ in })
        .store(in: &cancellables)
}
```

**é—®é¢˜**ï¼šç”¨æˆ·å¿«é€Ÿè¿ç»­ç‚¹å‡»ä¸¤æ¬¡ï¼š
1. ç¬¬ä¸€æ¬¡ï¼š`isCurrently = false` â†’ ä¹è§‚æ›´æ–°ä¸º `true` â†’ å‘èµ·è®¢é˜…è¯·æ±‚
2. ç¬¬äºŒæ¬¡ï¼š`isCurrently = true`ï¼ˆä¹è§‚æ›´æ–°åï¼‰â†’ ä¹è§‚æ›´æ–°ä¸º `false` â†’ å‘èµ·å–æ¶ˆè¯·æ±‚
3. ç¬¬ä¸€æ¬¡è¯·æ±‚å¤±è´¥ â†’ å›æ»šä¸º `false`ï¼ˆä¸ç¬¬äºŒæ¬¡çš„ä¹è§‚æ›´æ–°ä¸€è‡´ï¼Œçœ‹ä¼¼æ­£ç¡®ï¼‰
4. ç¬¬äºŒæ¬¡è¯·æ±‚æˆåŠŸ â†’ æœ€ç»ˆçŠ¶æ€ `false`

ä½†å¦‚æœç¬¬ä¸€æ¬¡æˆåŠŸã€ç¬¬äºŒæ¬¡å¤±è´¥ï¼š
1. ç¬¬ä¸€æ¬¡æˆåŠŸ â†’ æœåŠ¡ç«¯ä¸º `true`
2. ç¬¬äºŒæ¬¡å¤±è´¥ â†’ å›æ»šä¸º `true`ï¼ˆæœ¬åœ°ï¼‰
3. æœ¬åœ° `true`ï¼ŒæœåŠ¡ç«¯ `true` â†’ çœ‹ä¼¼ä¸€è‡´ï¼Œä½†ç”¨æˆ·æ„å›¾æ˜¯å–æ¶ˆ

**ä¿®å¤æ–¹æ¡ˆ**ï¼š
- æ·»åŠ  debounce æˆ– loading çŠ¶æ€ï¼Œé˜²æ­¢å¿«é€Ÿè¿ç»­æ“ä½œ
- æˆ–è€…ä½¿ç”¨è¯·æ±‚åºåˆ—å·ï¼Œåªå¤„ç†æœ€æ–°è¯·æ±‚çš„å›æ»š



---

## æ¨¡å—å®¡è®¡ç»†èŠ‚

### Network å±‚ï¼ˆAPIService + NCMBridgeï¼‰

**æ¶æ„**ï¼š
- `NCMClient` æä¾› async/await APIï¼Œé€šè¿‡ `NCMBridge` æ¡¥æ¥ä¸º Combine Publisher
- `APIService` ä½œä¸ºç»Ÿä¸€å…¥å£ï¼Œå°è£…æ‰€æœ‰ä¸šåŠ¡æ¥å£
- æ”¯æŒåç«¯ä»£ç†æ¨¡å¼ï¼ˆNode.js ä¸­é—´å±‚ï¼‰å’Œç›´è¿æ¨¡å¼

**ä¼˜ç‚¹**ï¼š
- NCMBridge çš„ `Publisher â†’ async/await` æ¡¥æ¥å®ç°æ­£ç¡®ï¼Œä½¿ç”¨ `didResume` æ ‡å¿—é˜²æ­¢é‡å¤ resume
- `ncm.fetch` æ³›å‹æ–¹æ³•æ”¯æŒ keyPath è§£ç ï¼Œå‡å°‘æ ·æ¿ä»£ç 
- è§£ç°åŠŸèƒ½é€šè¿‡ `UnblockManager` æ’ä»¶åŒ–å®ç°ï¼Œå¯åŠ¨æ€å¼€å…³

**é—®é¢˜**ï¼š
1. Cookie å­˜å‚¨ï¼ˆè§ P0-1ï¼‰
2. CachePolicy æ­»ä»£ç ï¼ˆè§ P1-4ï¼‰
3. `postToBackend` é™æ€æ–¹æ³•ç›´æ¥è®¿é—® `APIService.shared.currentCookie`ï¼Œç ´åäº†æ–¹æ³•çš„ç‹¬ç«‹æ€§
4. ç™»å‡ºæµç¨‹ä¸­ `currentCookie = nil` è§¦å‘ `currentUserId = nil` çš„çº§è” didSetï¼Œé€»è¾‘éšæ™¦

**æ–‡ä»¶æ¸…å•**ï¼š
- `APIService.swift`ï¼ˆ1070 è¡Œï¼‰â€” ä¸»æœåŠ¡ï¼ŒåŒ…å«è®¤è¯ã€é¦–é¡µã€æ­Œå•ã€æ­Œæ‰‹ã€ç”¨æˆ·ã€æ­Œè¯ã€æ”¶è—ã€è¯„è®ºç­‰å…¨éƒ¨æ¥å£
- `APIService+Search.swift` â€” æœç´¢ç›¸å…³æ¥å£
- `APIService+MV.swift` â€” MV ç›¸å…³æ¥å£
- `NCMBridge.swift` â€” NCMClient â†” Combine æ¡¥æ¥å±‚

---

### æ’­æ”¾å™¨å¼•æ“ï¼ˆPlayerManager + StreamPlayerï¼‰

**æ¶æ„**ï¼š
- `PlayerManager`ï¼ˆ@MainActor å•ä¾‹ï¼‰ç®¡ç†æ’­æ”¾çŠ¶æ€ã€é˜Ÿåˆ—ã€è¿œç¨‹æ§åˆ¶
- `StreamPlayer`ï¼ˆFFmpegSwiftSDKï¼‰è´Ÿè´£å®é™…éŸ³é¢‘è§£ç å’Œæ¸²æŸ“
- `StreamPlayerDelegateAdapter` æ¡¥æ¥ SDK å›è°ƒåˆ°ä¸»çº¿ç¨‹
- 10 æ®µ Biquad Peaking EQ é›†æˆåœ¨ AudioRenderer pipeline ä¸­

**ä¼˜ç‚¹**ï¼š
- æ’­æ”¾ä¼šè¯ ID æœºåˆ¶ï¼ˆ`playbackSessionId`ï¼‰æœ‰æ•ˆé˜²æ­¢åˆ‡æ­Œæ—¶çš„ç«æ€æ¡ä»¶
- seek debounceï¼ˆ50msï¼‰é¿å…å¿«é€Ÿæ‹–åŠ¨æ—¶çš„é¢‘ç¹ seek
- æ— ç¼åˆ‡æ­Œï¼š`prepareNext` + `switchToNext` é¢„åŠ è½½ä¸‹ä¸€é¦–
- éŸ³è´¨åˆ‡æ¢ï¼šä¿ç•™æ’­æ”¾è¿›åº¦ï¼Œé€šè¿‡ `pendingQualitySwitchSeek` æ ‡è®°
- è¿ç»­å¤±è´¥é€€é¿ï¼šæŒ‡æ•°é€€é¿ + æœ€å¤§å¤±è´¥æ¬¡æ•°ä¿æŠ¤
- åª’ä½“æœåŠ¡é‡ç½®æ¢å¤ï¼šç›‘å¬ `mediaServicesWereResetNotification`ï¼Œè‡ªåŠ¨é‡å»º audio session

**é—®é¢˜**ï¼š
1. restoreState ä¸¢å¤±æ’­æ”¾é˜Ÿåˆ—ï¼ˆè§ P0-2ï¼‰
2. å¼‚å¸¸ç»“æŸæ£€æµ‹æ¡ä»¶å®½æ¾ï¼ˆè§ P1-8ï¼‰
3. éŸ³è´¨åˆ‡æ¢è½®è¯¢æœºåˆ¶ï¼ˆ`pollAndSwitch`ï¼‰ä½¿ç”¨é€’å½’ `asyncAfter`ï¼Œä¸å¤Ÿä¼˜é›…
4. `timeUpdateTimer` åœ¨éæ’­æ”¾çŠ¶æ€ä»åœ¨è¿è¡Œï¼ˆæœ‰ guard ä¿æŠ¤ï¼Œä½† Timer æœ¬èº«æ¶ˆè€—èµ„æºï¼‰
5. `error` çŠ¶æ€ä¸‹ `consecutiveFailures >= maxConsecutiveFailures` æ—¶é‡ç½®è®¡æ•°å™¨ä½†æ—  UI æç¤º

**æ–‡ä»¶æ¸…å•**ï¼š
- `PlayerManager.swift`ï¼ˆ1118 è¡Œï¼‰â€” æ’­æ”¾ç®¡ç†å™¨ + StreamPlayerDelegateAdapter

---

### ç¼“å­˜ç³»ç»Ÿï¼ˆOptimizedCacheManager + CacheManagerï¼‰

**æ¶æ„**ï¼š
```
è¯·æ±‚ â†’ OptimizedCacheManager
         â”œâ”€ L1: NSCacheï¼ˆå†…å­˜ï¼Œ100MB / 200æ¡ï¼‰
         â”œâ”€ L2: SwiftDataï¼ˆSongRepository / PlaylistRepository / HistoryRepositoryï¼‰
         â””â”€ L3: CacheManager.sharedï¼ˆç£ç›˜æ–‡ä»¶ï¼ŒSHA256 æ–‡ä»¶åï¼‰
                 â””â”€ è‡ªå¸¦ NSCacheï¼ˆå†…å­˜ï¼Œ100MB / 100æ¡ï¼‰â† å†—ä½™
```

**ä¼˜ç‚¹**ï¼š
- `smartFetch` æ–¹æ³•å®ç°äº†ä¼˜é›…çš„é™çº§ï¼šå†…å­˜ â†’ ç£ç›˜ï¼ˆå¸¦ TTLï¼‰â†’ ç½‘ç»œ â†’ è¿‡æœŸç¼“å­˜å…œåº•
- å†…å­˜è­¦å‘Šå¤„ç†å®Œå–„ï¼šæ¸…ç† NSCache + CachedAsyncImage + LiquidGlassEngine
- ç£ç›˜ç¼“å­˜æ–‡ä»¶åä½¿ç”¨ SHA256ï¼Œå®‰å…¨ä¸”æ— å†²çª
- è¿‡æœŸæ¸…ç†ç­–ç•¥ï¼šæŒ‰æ—¶é—´ + æŒ‰æ€»å¤§å°ï¼ˆLRUï¼‰

**é—®é¢˜**ï¼š
1. åŒ NSCache å†—ä½™ï¼ˆè§ P1-6ï¼‰
2. @MainActor ä¸Šæ‰§è¡Œæ•°æ®åº“ I/Oï¼ˆè§ P1-3ï¼‰
3. ç£ç›˜ç¼“å­˜è¿‡æœŸæ—¶é—´å­˜å‚¨åœ¨æ–‡ä»¶çš„ `creationDate` å±æ€§ä¸­ï¼Œè¿™æ˜¯ä¸€ä¸ª hackï¼Œåœ¨æ–‡ä»¶å¤åˆ¶/å¤‡ä»½æ¢å¤åå¯èƒ½è¢«é‡ç½®
4. `CacheManager.init()` ä¸æ˜¯ `@MainActor`ï¼Œä½†è¢« `OptimizedCacheManager`ï¼ˆ@MainActorï¼‰å¼•ç”¨ï¼ŒSendable åˆè§„æ€§éœ€è¦å…³æ³¨

**æ–‡ä»¶æ¸…å•**ï¼š
- `OptimizedCacheManager.swift` â€” ä¸‰çº§ç¼“å­˜ç®¡ç†å™¨
- `CacheManager.swift` â€” ç£ç›˜ç¼“å­˜ + å†…å­˜ç¼“å­˜
- `DatabaseManager.swift` â€” SwiftData å®¹å™¨ç®¡ç†
- `Database/Repositories/` â€” SongRepositoryã€PlaylistRepositoryã€HistoryRepository

---

### æ•°æ®åº“å±‚ï¼ˆDatabaseManager + Repositoriesï¼‰

**æ¶æ„**ï¼š
- SwiftData ä½œä¸ºæŒä¹…åŒ–å±‚ï¼Œ7 ä¸ª Modelï¼ˆCachedSongã€CachedPlaylistã€CachedArtistã€PlayHistoryã€SearchHistoryã€CachedLyricsã€DownloadedSongï¼‰
- ä¸‰çº§é™çº§åˆå§‹åŒ–ï¼šç£ç›˜æ•°æ®åº“ â†’ åˆ é™¤æŸåæ–‡ä»¶é‡å»º â†’ å†…å­˜æ•°æ®åº“
- Repository æ¨¡å¼å°è£… CRUD æ“ä½œ

**ä¼˜ç‚¹**ï¼š
- ä¸‰çº§é™çº§ç¡®ä¿ App ä¸ä¼šå› æ•°æ®åº“æŸåè€Œå´©æºƒ
- æœ€åçš„ `force_try` ç”¨äºå†…å­˜æ•°æ®åº“ï¼Œåˆç†ï¼ˆå†…å­˜æ•°æ®åº“ä¸åº”å¤±è´¥ï¼‰
- `cleanExpiredData` ä½¿ç”¨ `#Predicate` æ‰¹é‡åˆ é™¤ï¼Œæ•ˆç‡å¥½
- åŒæ—¶åˆ é™¤ WAL å’Œ SHM æ–‡ä»¶ï¼Œæ¸…ç†å½»åº•

**é—®é¢˜**ï¼š
- `DatabaseManager` æ˜¯ `@MainActor`ï¼Œæ‰€æœ‰æ•°æ®åº“æ“ä½œåœ¨ä¸»çº¿ç¨‹ï¼ˆè§ P1-3ï¼‰
- `calculateDatabaseSize` ç¡¬ç¼–ç äº† `default.store` è·¯å¾„ï¼Œå¦‚æœ SwiftData ä½¿ç”¨ä¸åŒçš„æ–‡ä»¶åä¼šè¿”å› "0 MB"

---

### æ•°æ®åŒæ­¥ï¼ˆGlobalRefreshManager + DataSyncCoordinatorï¼‰

**æ¶æ„**ï¼š
- `GlobalRefreshManager` ç»Ÿä¸€ç®¡ç†åˆ·æ–°è§¦å‘ï¼ˆç™»å½•ã€æ¯æ—¥ã€æ‰‹åŠ¨ã€å‰å°æ¢å¤ï¼‰
- `DataSyncCoordinator` åè°ƒç½‘ç»œè¯·æ±‚ä¸ç¼“å­˜åŒæ­¥
- é€šè¿‡ Combine `PassthroughSubject` å‘å¸ƒåˆ·æ–°äº‹ä»¶

**ä¼˜ç‚¹**ï¼š
- åˆ·æ–°å†·å´æœºåˆ¶ï¼ˆ30 ç§’å†…ä¸é‡å¤åˆ·æ–°ï¼‰
- æ¯æ—¥åˆ·æ–°æ£€æµ‹ï¼ˆè·¨å¤©è‡ªåŠ¨åˆ·æ–°ï¼‰
- è¿›å…¥åå°æ—¶åŒæ­¥æ•°æ®åˆ°æ•°æ®åº“
- `smartSync` æ–¹æ³•æ”¯æŒç¼“å­˜æœ‰æ•ˆæœŸæ£€æŸ¥

**é—®é¢˜**ï¼š
1. `waitForCoreDataReady` ä½¿ç”¨ `Task.sleep` è½®è¯¢ï¼ˆ100ms é—´éš”ï¼Œ8 ç§’è¶…æ—¶ï¼‰ï¼Œä¸å¤Ÿä¼˜é›…
2. `DataSyncCoordinator` çš„ continuation æ³„æ¼é£é™©ï¼ˆè§ P1-7ï¼‰
3. `HomeViewModel.fetchAllData` ä¸­çš„ `checkAndMarkReady` é—­åŒ…æ•è·å±€éƒ¨å˜é‡ï¼Œå¤šä¸ªå¼‚æ­¥å›è°ƒä¿®æ”¹åŒä¸€ç»„å˜é‡ï¼Œé€»è¾‘å¤æ‚æ˜“é—æ¼

---

### EQ å‡è¡¡å™¨ï¼ˆEQManager + EQPresetï¼‰

**æ¶æ„**ï¼š
- 24 ä¸ªå†…ç½®é¢„è®¾ï¼ˆ11 éŸ³ä¹é£æ ¼ + 11 ç¯ç»•éŸ³æ•ˆ + 8 åœºæ™¯ + 4 äººå£° + 1 å¹³å¦ï¼‰
- æ”¯æŒè‡ªå®šä¹‰é¢„è®¾ä¿å­˜/åˆ é™¤
- çŠ¶æ€æŒä¹…åŒ–åˆ° OptimizedCacheManager
- å®æ—¶åº”ç”¨åˆ° StreamPlayer çš„ AudioEqualizer

**ä¼˜ç‚¹**ï¼š
- é¢„è®¾å‚æ•°åŸºäºä¸“ä¸šéŸ³é¢‘å·¥ç¨‹æ ‡å‡†ï¼Œæœ‰è¯¦ç»†çš„å‚è€ƒè¯´æ˜ï¼ˆHarman Target Curveã€THXã€Dolby Atmos ç­‰ï¼‰
- 10 æ®µé¢‘ç‡è¦†ç›– 31Hz-16kHzï¼Œå¢ç›ŠèŒƒå›´ Â±12dB
- è‡ªå®šä¹‰é¢„è®¾ä½¿ç”¨ UUID å‰ç¼€é¿å… ID å†²çª

**é—®é¢˜**ï¼š
1. åˆå§‹åŒ–å¾ªç¯ä¾èµ–ï¼ˆè§ P1-9ï¼‰
2. `isEnabled` çš„ `didSet` ä¸­ç›´æ¥è°ƒç”¨ `PlayerManager.shared.equalizer.reset()`ï¼Œå¦‚æœ PlayerManager æœªåˆå§‹åŒ–ä¼šè§¦å‘å…¶ init

---

### è®¢é˜…ç®¡ç†ï¼ˆSubscriptionManagerï¼‰

**æ¶æ„**ï¼š
- ç®¡ç†æ’­å®¢è®¢é˜…å’Œæ­Œå•æ”¶è—
- ä¹è§‚æ›´æ–° + å¤±è´¥å›æ»šæ¨¡å¼
- é€šè¿‡ `Set<Int>` å¿«é€ŸæŸ¥è¯¢è®¢é˜…çŠ¶æ€

**ä¼˜ç‚¹**ï¼š
- ä¹è§‚æ›´æ–°æä¾›å³æ—¶ UI åé¦ˆ
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š
- æ”¶è—æˆåŠŸåè§¦å‘ Library åˆ·æ–°

**é—®é¢˜**ï¼š
1. å¿«é€Ÿè¿ç»­æ“ä½œçš„ç«æ€ï¼ˆè§ P1-10ï¼‰
2. `fetchSubscribedRadios` å›ºå®š limit=200ï¼Œå¦‚æœç”¨æˆ·è®¢é˜…è¶…è¿‡ 200 ä¸ªæ’­å®¢ä¼šä¸¢å¤±æ•°æ®

---

### UI å±‚

**æ¶æ„**ï¼š
- è®¾è®¡ç³»ç»Ÿï¼šAsideBackgroundã€AsideIconã€AsideAlertã€AsideLoadingViewã€AsideBouncingButtonStyle
- é¢œè‰²ç³»ç»Ÿï¼šTheme.swift å®šä¹‰è‡ªé€‚åº”é¢œè‰²ï¼ˆlight/darkï¼‰
- Tab åˆ‡æ¢ï¼šopacity é¢„åŠ è½½ç­–ç•¥ï¼ˆ4 ä¸ªé¡µé¢å¸¸é©»å†…å­˜ï¼‰
- æµ®åŠ¨æ ï¼šUnifiedFloatingBarï¼ˆMiniPlayer + TabBar åˆä¸€ï¼‰
- æ¶²æ€ç»ç’ƒï¼šLiquidGlassEffect å¯é€‰å¼€å…³

**ä¼˜ç‚¹**ï¼š
- è®¾è®¡ç³»ç»Ÿç»„ä»¶åŒ–ç¨‹åº¦é«˜ï¼Œé£æ ¼ç»Ÿä¸€
- è‡ªé€‚åº”é¢œè‰²ä½¿ç”¨ `UIColor { traitCollection in }` å®ç°ï¼Œæ­£ç¡®
- UnifiedFloatingBar æ ¹æ®æ’­æ”¾æºï¼ˆnormal/fm/podcastï¼‰æ‰“å¼€ä¸åŒæ’­æ”¾å™¨
- TabBar æ°”æ³¡åŠ¨ç”»ä½¿ç”¨ `offset` + `spring` åŠ¨ç”»ï¼Œæµç•…

**é—®é¢˜**ï¼š
1. WaveformProgressBar é‡å¤å®ç°ï¼ˆè§ P1-5ï¼‰
2. NotificationCenter å­—ç¬¦ä¸²é€šçŸ¥åï¼ˆè§ P2-11ï¼‰ï¼š
   ```swift
   NotificationCenter.default.post(name: .init("OpenFMPlayer"), object: nil)
   NotificationCenter.default.post(name: .init("OpenNormalPlayer"), object: nil)
   NotificationCenter.default.post(name: .init("OpenRadioPlayer"), object: radioId)
   NotificationCenter.default.post(name: .init("SwitchToLibrarySquare"), object: nil)
   ```
   åº”å®šä¹‰ä¸º `Notification.Name` å¸¸é‡
3. `Tab.icon` å±æ€§è¿”å› SF Symbol å­—ç¬¦ä¸²ä½†æœªè¢«ä½¿ç”¨ï¼ˆTabBar å·²ä½¿ç”¨ AsideIcon ç³»ç»Ÿï¼‰
4. `ContentView` ä¸­ 4 ä¸ªé¡µé¢å…¨éƒ¨å¸¸é©»å†…å­˜ï¼Œå†…å­˜å ç”¨è¾ƒé«˜ï¼ˆä½†åˆ‡æ¢æµç•…ï¼‰
5. `TimelineView(.animation(minimumInterval: 0.12))` åœ¨ WaveformProgressBar ä¸­æŒç»­è§¦å‘é‡ç»˜ï¼Œå³ä½¿ View ä¸å¯è§

---

### å·¥å…·å±‚ï¼ˆAppConfig + ErrorHandlerï¼‰

**AppConfig**ï¼š
- é›†ä¸­ç®¡ç†æ‰€æœ‰å¸¸é‡ï¼ˆç¼“å­˜ã€APIã€æ’­æ”¾å™¨ã€UIã€å­˜å‚¨é”®ã€ç¼“å­˜é”®ï¼‰
- æ¶ˆé™¤äº†é­”æ³•æ•°å­—ï¼Œè‰¯å¥½

**ErrorHandler**ï¼š
- ç»Ÿä¸€é”™è¯¯å¤„ç†ï¼šè½¬æ¢ä¸º `AppError` â†’ æ—¥å¿—è®°å½• â†’ UI åé¦ˆ
- æ”¯æŒé‡è¯•æ“ä½œ
- Combine æ‰©å±• `.handleError()` ä¾¿æ·æ–¹æ³•
- `AppError` æä¾›ç”¨æˆ·å‹å¥½çš„ä¸­æ–‡æè¿°

**é—®é¢˜**ï¼š
- `ErrorHandler` å­˜åœ¨ä½†æœªåœ¨æ‰€æœ‰ API è°ƒç”¨ä¸­ä¸€è‡´ä½¿ç”¨ã€‚éƒ¨åˆ† ViewModel ç›´æ¥ `AppLogger.error()` è€Œä¸ç»è¿‡ ErrorHandler

---

### ç™»å½•æµç¨‹ï¼ˆLoginViewModelï¼‰

**æ¶æ„**ï¼š
- æ”¯æŒäºŒç»´ç ç™»å½•å’Œæ‰‹æœºéªŒè¯ç ç™»å½•
- äºŒç»´ç ï¼šfetchQRKey â†’ fetchQRCreate â†’ ç”ŸæˆäºŒç»´ç å›¾ç‰‡ â†’ è½®è¯¢ checkQRStatus
- æ‰‹æœºï¼šsendCaptcha â†’ loginCellphone

**ä¼˜ç‚¹**ï¼š
- äºŒç»´ç æ”¯æŒä¸¤ç§æ¨¡å¼ï¼šåç«¯è¿”å› base64 å›¾ç‰‡ / å®¢æˆ·ç«¯ CoreImage ç”Ÿæˆ
- è½®è¯¢é—´éš” 3 ç§’ï¼Œåˆç†
- è¿‡æœŸæ£€æµ‹ï¼ˆcode 800ï¼‰ååœæ­¢è½®è¯¢

**é—®é¢˜**ï¼š
- `deinit` ä¸­ `timer?.cancel()` å¯èƒ½ä¸ä¼šè¢«è°ƒç”¨ï¼ˆSwiftUI ä¸­ ViewModel çš„ deinit æ—¶æœºä¸ç¡®å®šï¼‰
- ç™»å½•æˆåŠŸåçš„çŠ¶æ€åŒæ­¥åˆ†æ•£åœ¨å¤šå¤„ï¼ˆ`UserDefaults.set(true, forKey: "isLoggedIn")`ã€`NotificationCenter.post`ã€`GlobalRefreshManager.triggerLoginRefresh`ï¼‰ï¼Œåº”è¯¥æ”¶æ•›åˆ°ä¸€ä¸ªæ–¹æ³•ä¸­

---

## ä¸ä¸Šæ¬¡å®¡è®¡ï¼ˆ2026-02-07ï¼‰çš„å¯¹æ¯”

| é¡¹ç›® | 2026-02-07 çŠ¶æ€ | 2026-02-12 çŠ¶æ€ |
|------|----------------|----------------|
| æ’­æ”¾å¼•æ“ | AVFoundation/AVPlayer | âœ… å·²è¿ç§»åˆ° FFmpegSwiftSDK StreamPlayer |
| EQ å‡è¡¡å™¨ | æ—  | âœ… æ–°å¢ 10 æ®µ EQ + 24 é¢„è®¾ |
| å›¾æ ‡ç³»ç»Ÿ | SF Symbols | âœ… å·²è¿ç§»åˆ° AsideIcon è‡ªå®šä¹‰å›¾æ ‡ç³»ç»Ÿ |
| Cookie å­˜å‚¨ | UserDefaultsï¼ˆP0ï¼‰ | âš ï¸ ä»æœªä¿®å¤ï¼Œä»åœ¨ UserDefaults |
| æ•°æ®åº“åˆå§‹åŒ– | fatalError å´©æºƒï¼ˆP1ï¼‰ | âœ… å·²ä¿®å¤ï¼Œä¸‰çº§é™çº§ç­–ç•¥ |
| å¼ºåˆ¶è§£åŒ… | å¤šå¤„ force unwrapï¼ˆP0ï¼‰ | âœ… å¤§éƒ¨åˆ†å·²ä¿®å¤ï¼ˆ`priv.id!` ä»å­˜åœ¨äº Privilege å¤„ç†ä¸­ï¼‰ |
| HTTP å›é€€ | å­˜åœ¨ï¼ˆP0ï¼‰ | âœ… å·²è¿ç§»åˆ° NCMClientï¼Œç”± SecureConfig ç®¡ç† |
| æ’­æ”¾é˜Ÿåˆ—æŒä¹…åŒ– | æœªæ£€æŸ¥ | âš ï¸ æ–°å‘ç°é—®é¢˜ï¼šä¸¢å¤±å®Œæ•´ context |

---

## ä»£ç è´¨é‡ç»Ÿè®¡

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| æ ¸å¿ƒä¸šåŠ¡ä»£ç è¡Œæ•°ï¼ˆä¼°ç®—ï¼‰ | ~15,000 è¡Œ |
| View æ–‡ä»¶æ•° | ~30 ä¸ª |
| ViewModel æ–‡ä»¶æ•° | 5 ä¸ª |
| Manager æ–‡ä»¶æ•° | 8 ä¸ª |
| Model æ–‡ä»¶æ•° | 5 ä¸ª |
| Network æ–‡ä»¶æ•° | 4 ä¸ª |
| Database æ–‡ä»¶æ•° | 7 ä¸ª |
| å•ä¾‹æ•°é‡ | 10+ ä¸ª |
| å•å…ƒæµ‹è¯•è¦†ç›– | æ— å®é™…æµ‹è¯•ç”¨ä¾‹ |

---

## ä¿®å¤ä¼˜å…ˆçº§æ€»ç»“

### P0ï¼ˆç«‹å³ä¿®å¤ï¼‰
1. Cookie è¿ç§»åˆ° Keychain
2. PlayerState æŒä¹…åŒ–å®Œæ•´æ’­æ”¾é˜Ÿåˆ—

### P1ï¼ˆè¿‘æœŸä¿®å¤ï¼‰
3. æ•°æ®åº“æ‰¹é‡ I/O ç§»åˆ°åå°çº¿ç¨‹
4. æ¸…ç† CachePolicy æ­»ä»£ç 
5. æå– WaveformProgressBar å…±äº«ç»„ä»¶
6. ç»Ÿä¸€ç¼“å­˜å±‚ï¼Œæ¶ˆé™¤åŒ NSCache
7. ä¿®å¤ DataSyncCoordinator continuation æ³„æ¼
8. æ”¶ç´§å¼‚å¸¸ç»“æŸæ£€æµ‹æ¡ä»¶
9. è§£å†³ EQManager åˆå§‹åŒ–å¾ªç¯ä¾èµ–
10. æ·»åŠ è®¢é˜…æ“ä½œ debounce

### P2ï¼ˆé•¿æœŸä¼˜åŒ–ï¼‰
11. NotificationCenter é€šçŸ¥åå¸¸é‡åŒ–
12. æ¸…ç† Tab.icon æ­»ä»£ç 
13. è€ƒè™‘ä¾èµ–æ³¨å…¥æ›¿ä»£å…¨å±€å•ä¾‹
14. WaveformProgressBar åå°æš‚åœé‡ç»˜
15. è¡¥å……å•å…ƒæµ‹è¯•

---

## å»ºè®®çš„ä¸‹ä¸€æ­¥

1. ä¼˜å…ˆä¿®å¤ P0 é¡¹ï¼ˆCookie Keychain è¿ç§» + æ’­æ”¾é˜Ÿåˆ—æŒä¹…åŒ–ï¼‰
2. è¡¥å……æ ¸å¿ƒè·¯å¾„çš„å•å…ƒæµ‹è¯•ï¼ˆæ’­æ”¾å™¨çŠ¶æ€æœºã€ç¼“å­˜ç­–ç•¥ã€ç½‘ç»œé”™è¯¯å¤„ç†ï¼‰
3. å¼•å…¥ CI æµç¨‹ï¼ˆæ„å»º + é™æ€åˆ†æ + æ ¼å¼æ£€æŸ¥ï¼‰
4. è€ƒè™‘å¼•å…¥ SwiftLint ç»Ÿä¸€ä»£ç é£æ ¼
